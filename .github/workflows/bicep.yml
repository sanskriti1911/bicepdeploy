
name: Azure Bicep Deployment
run-name: "Bicep Deploy - ${{ github.ref_name }}"

on:
  workflow_dispatch:
    inputs:
      subscriptionId:
        description: 'Azure Subscription ID (optional, overrides secret subscription)'
        required: false
        default: '679f3d56-bed2-429f-9e31-4d7bf67e14c7'
  push:
    branches: [ master ]

permissions:
  contents: read

jobs:
  validate:
    name: Validate Bicep (build & what-if)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure Login (Service Principal)
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Select Subscription (optional)
        if: ${{ inputs.subscriptionId != '' }}
        run: az account set --subscription "${{ inputs.subscriptionId }}"

      - name: Using existing Resource Group
        run: |
          echo "Using existing resource group: Sanskriti_MahendraRG"
          az group show --name "Sanskriti_Mahendra_RG" --output table

      - name: Bicep Build (syntax check)
        run: |
          az bicep version
          az bicep build --file main.bicep --outfile main.json

      - name: What-If (preview changes)
        run: |
          az deployment group what-if \
            --resource-group "Sanskriti_Mahendra_RG" \
            --template-file main.bicep \
            --parameters main.parameters.json

  deploy:
    name: Deploy to Azure
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure Login (Service Principal)
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Select Subscription (optional)
        if: ${{ inputs.subscriptionId != '' }}
        run: az account set --subscription "${{ inputs.subscriptionId }}"

      - name: Using existing Resource Group
        run: |
          echo "Using existing resource group: Sanskriti_Mahendra_RG"
          az group show --name "Sanskriti_Mahendra_RG" --output table

      - name: Deploy Bicep
        id: deploy
        run: |
          az deployment group create \
            --resource-group "Sanskriti-Sanskriti_Mahendra_RG" \
            --template-file main.bicep \
            --parameters main.parameters.json \
            --mode Incremental \
            --output json > deployment-output.json
          echo "Deployment outputs:" && cat deployment-output.json

      - name: Print Web URL
        run: |
          WEB_URL=$(jq -r '.properties.outputs.webUrl.value' deployment-output.json)
          echo "Web URL: $WEB_URL"
